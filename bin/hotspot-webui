#!/bin/sh
set -eu

CONF="/etc/hotspot.conf"
HOSTAPD_CONF="/etc/hostapd/hostapd-hotspot.conf"
DNSMASQ_CONF="/etc/dnsmasq.d/hotspot.conf"

# Defaults
IP_CIDR_DEFAULT="192.168.4.1/24"
DHCP_RANGE_DEFAULT="192.168.4.10,192.168.4.100,12h"

# load optional config
IFACE=""
SSID="MeinHotspot"
PASS=""

IP_CIDR="$IP_CIDR_DEFAULT"
DHCP_RANGE="$DHCP_RANGE_DEFAULT"

[ -f "$CONF" ] && . "$CONF" || true

pick_iface() {
  # 1) If IFACE is set and exists -> use it
  if [ -n "${IFACE:-}" ] && [ -d "/sys/class/net/$IFACE" ]; then
    echo "$IFACE"; return 0
  fi

  # 2) Prefer "wlan1" if present
  if [ -d /sys/class/net/wlan1 ]; then
    echo "wlan1"; return 0
  fi

  # 3) Use first wireless interface except wlan0 (if possible)
  if command -v iw >/dev/null 2>&1; then
    cands="$(iw dev 2>/dev/null | awk '$1=="Interface"{print $2}')"
    for i in $cands; do
      [ "$i" = "wlan0" ] && continue
      echo "$i"; return 0
    done
    for i in $cands; do
      echo "$i"; return 0
    done
  fi

  # 4) Fallback: sysfs
  for i in $(ls /sys/class/net 2>/dev/null | grep -E '^wl' || true); do
    [ "$i" = "wlan0" ] && continue
    echo "$i"; return 0
  done

  return 1
}

svc_start() {
  if command -v systemctl >/dev/null 2>&1; then
    systemctl start dnsmasq 2>/dev/null || true
    systemctl start hostapd 2>/dev/null || true
  elif [ -x /etc/init.d/dnsmasq ]; then
    /etc/init.d/dnsmasq start || true
    /etc/init.d/hostapd start || true
  else
    return 1
  fi
}

svc_stop() {
  if command -v systemctl >/dev/null 2>&1; then
    systemctl stop hostapd 2>/dev/null || true
    systemctl stop dnsmasq 2>/dev/null || true
  elif [ -x /etc/init.d/dnsmasq ]; then
    /etc/init.d/hostapd stop || true
    /etc/init.d/dnsmasq stop || true
  else
    return 1
  fi
}

write_configs() {
  # dnsmasq snippet
  mkdir -p "$(dirname "$DNSMASQ_CONF")"
  cat >"$DNSMASQ_CONF" <<EOF
interface=$IFACE
dhcp-range=$DHCP_RANGE
EOF

  # hostapd config
  mkdir -p "$(dirname "$HOSTAPD_CONF")"

  if [ -n "${PASS:-}" ]; then
    WPA_BLOCK=$(cat <<EOW
wpa=2
wpa_passphrase=$PASS
wpa_key_mgmt=WPA-PSK
rsn_pairwise=CCMP
EOW
)
  else
    WPA_BLOCK="auth_algs=1"
  fi

  cat >"$HOSTAPD_CONF" <<EOF
interface=$IFACE
driver=nl80211
ssid=$SSID
hw_mode=g
channel=6
ieee80211n=1
wmm_enabled=1
$WPA_BLOCK
EOF
}

do_status() {
  IFACE="$(pick_iface 2>/dev/null || true)"
  echo "iface=${IFACE:-<none>}"
  if [ -n "${IFACE:-}" ]; then
    ip -br addr show "$IFACE" 2>/dev/null || true
  fi

  if command -v systemctl >/dev/null 2>&1; then
    systemctl is-active hostapd 2>/dev/null | sed 's/^/hostapd=/' || true
    systemctl is-active dnsmasq 2>/dev/null | sed 's/^/dnsmasq=/' || true
  else
    pidof hostapd >/dev/null 2>&1 && echo "hostapd=active" || echo "hostapd=inactive"
    pidof dnsmasq  >/dev/null 2>&1 && echo "dnsmasq=active"  || echo "dnsmasq=inactive"
  fi

  echo "ssid=$SSID"
  if [ -n "${PASS:-}" ]; then echo "security=WPA2-PSK"; else echo "security=OPEN"; fi
  echo "ip_cidr=$IP_CIDR"
  echo "dhcp_range=$DHCP_RANGE"
}

do_on() {
  IFACE="$(pick_iface)"
  echo "Using iface=$IFACE"

  # ensure configs exist
  write_configs

  # set IP
  ip link set "$IFACE" up || true
  ip addr flush dev "$IFACE" || true
  ip addr add "$IP_CIDR" dev "$IFACE"

  # start services
  svc_start || { echo "ERROR: cannot start services"; exit 0; }

  echo "OK: hotspot started ($SSID) on $IFACE ($IP_CIDR)"
}

do_off() {
  svc_stop || true
  IFACE="$(pick_iface 2>/dev/null || true)"
  [ -n "${IFACE:-}" ] && ip addr flush dev "$IFACE" 2>/dev/null || true
  echo "OK: hotspot stopped"
}

do_save() {
  SSID="$1"
  PASS="${2:-}"

  # Persist
  cat >"$CONF" <<EOF
# Hotspot config (sourced by hotspot-webui)
SSID=$(printf '%s' "$SSID" | sed 's/"/\\"/g')
PASS=$(printf '%s' "$PASS" | sed 's/"/\\"/g')
IP_CIDR=$IP_CIDR
DHCP_RANGE=$DHCP_RANGE
# Optional fixed interface:
# IFACE=wlan1
EOF

  echo "OK: saved (ssid=$SSID, pass=$( [ -n "$PASS" ] && echo set || echo empty ))"
}

ACTION="${1:-status}"
case "$ACTION" in
  status) do_status ;;
  on)     do_on ;;
  off)    do_off ;;
  save)   shift; do_save "${1:-}" "${2:-}" ;;
  *) echo "ERROR: invalid action";;
esac