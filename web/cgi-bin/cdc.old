#!/bin/sh
set -eu

# Minimal-JSON helper
json_escape() { sed 's/\\/\\\\/g; s/"/\\"/g'; }

ACTION="${QUERY_STRING:-}"

# very strict: only allow exact tokens
case "$ACTION" in
  action=status|action=up|action=down) : ;;
  *) ACTION="action=status" ;;
esac

run() {
  # run fixed commands only; no user input goes into shell
  case "$1" in
    status) /usr/local/sbin/cdc-share status ;;
    up)     sudo -n /usr/local/sbin/cdc-share up ;;
    down)   sudo -n /usr/local/sbin/cdc-share down ;;
  esac
}

cmd="status"
[ "$ACTION" = "action=up" ] && cmd="up"
[ "$ACTION" = "action=down" ] && cmd="down"

OUT="$(run "$cmd" 2>&1 || true)"
OK="true"
echo "$OUT" | grep -qiE 'permission denied|sudo:' && OK="false"

printf "Content-Type: application/json\r\n\r\n"
printf '{ "ok": %s, "action": "%s", "output": "%s" }\n' \
  "$OK" "$cmd" "$(printf "%s" "$OUT" | json_escape)"
