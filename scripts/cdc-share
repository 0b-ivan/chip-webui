#!/bin/sh
set -eu

USB_IF="usb0"
USB_ADDR="192.168.7.1/24"
DNSMASQ_CONF="/etc/dnsmasq.d/usb0.conf"

# detect uplink interface (default route)
UPLINK_IF="$(ip route 2>/dev/null | awk '/^default/ {print $5; exit}')"
[ -n "${UPLINK_IF:-}" ] || UPLINK_IF="wlan0"

status() {
  echo "uplink_if=$UPLINK_IF"
  ip -br link show "$USB_IF" 2>/dev/null || true
  ip -br addr show "$USB_IF" 2>/dev/null || true
  sysctl -n net.ipv4.ip_forward 2>/dev/null | awk '{print "ip_forward="$1}'
  if command -v iptables >/dev/null 2>&1; then
    iptables -t nat -S 2>/dev/null | grep -F "MASQUERADE" || true
    iptables -S FORWARD 2>/dev/null | grep -E "\-i ($USB_IF|$UPLINK_IF)" || true
  else
    echo "iptables=missing"
  fi
  pgrep -a dnsmasq 2>/dev/null || echo "dnsmasq=not-running"
}

ensure_dnsmasq_conf() {
  # minimal DHCP for usb0
  if [ ! -f "$DNSMASQ_CONF" ]; then
    cat > "$DNSMASQ_CONF" <<CONF
interface=$USB_IF
bind-interfaces
dhcp-range=192.168.7.2,192.168.7.50,255.255.255.0,12h
dhcp-option=3,192.168.7.1
dhcp-option=6,1.1.1.1,8.8.8.8
CONF
  fi
}

dnsmasq_restart_usb0() {
  # kill only dnsmasq instances bound to usb0 if possible; otherwise restart service
  if pgrep dnsmasq >/dev/null 2>&1; then
    # safest pragmatic approach on Buster: restart system service
    systemctl restart dnsmasq 2>/dev/null || true
  else
    systemctl start dnsmasq 2>/dev/null || true
  fi
}

up() {
  # bring up usb0 and set IP
  ip link set "$USB_IF" up || true
  ip addr flush dev "$USB_IF" || true
  ip addr add "$USB_ADDR" dev "$USB_IF"

  # enable forwarding
  sysctl -w net.ipv4.ip_forward=1 >/dev/null

  # iptables legacy on Buster: NAT + forwarding
  if command -v iptables >/dev/null 2>&1; then
    # NAT
    iptables -t nat -C POSTROUTING -o "$UPLINK_IF" -j MASQUERADE 2>/dev/null || \
      iptables -t nat -A POSTROUTING -o "$UPLINK_IF" -j MASQUERADE

    # forwarding rules
    iptables -C FORWARD -i "$USB_IF" -o "$UPLINK_IF" -j ACCEPT 2>/dev/null || \
      iptables -A FORWARD -i "$USB_IF" -o "$UPLINK_IF" -j ACCEPT

    iptables -C FORWARD -i "$UPLINK_IF" -o "$USB_IF" -m state --state RELATED,ESTABLISHED -j ACCEPT 2>/dev/null || \
      iptables -A FORWARD -i "$UPLINK_IF" -o "$USB_IF" -m state --state RELATED,ESTABLISHED -j ACCEPT
  fi

  ensure_dnsmasq_conf
  dnsmasq_restart_usb0

  echo "OK: CDC sharing enabled (usb0=$USB_ADDR uplink=$UPLINK_IF)"
}

down() {
  # stop DHCP for usb0 (keep dnsmasq if used elsewhere: leave running; or restart without usb0 conf)
  if [ -f "$DNSMASQ_CONF" ]; then
    rm -f "$DNSMASQ_CONF"
    systemctl restart dnsmasq 2>/dev/null || true
  fi

  # remove iptables rules (best effort)
  if command -v iptables >/dev/null 2>&1; then
    iptables -t nat -D POSTROUTING -o "$UPLINK_IF" -j MASQUERADE 2>/dev/null || true
    iptables -D FORWARD -i "$USB_IF" -o "$UPLINK_IF" -j ACCEPT 2>/dev/null || true
    iptables -D FORWARD -i "$UPLINK_IF" -o "$USB_IF" -m state --state RELATED,ESTABLISHED -j ACCEPT 2>/dev/null || true
  fi

  # drop address
  ip addr flush dev "$USB_IF" 2>/dev/null || true

  echo "OK: CDC sharing disabled"
}

case "${1:-status}" in
  status) status ;;
  up) up ;;
  down) down ;;
  *) echo "usage: $0 {status|up|down}" >&2; exit 2 ;;
esac
